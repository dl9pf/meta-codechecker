name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    container:
      image: crops/poky:ubuntu-18.04
      options: --user 1001:1001
    strategy:
      matrix:
        include:
          - oe-version-name: dunfell
            oe-version: 23.0.10
          - oe-version-name: gatesgarth
            oe-version: 24.0.4
          - oe-version-name: hardknott
            oe-version: 3.3.2
      fail-fast: false


    steps:
    - name: Install required layers
      run: |
        POKY_BRANCH="${{ matrix.oe-version-name }}-${{ matrix.oe-version }}"
        OE_BRANCH="${{ matrix.oe-version-name }}"

        echo "Getting layer for Poky version: ${POKY_BRANCH} / OE version: ${OE_BRANCH}"
        git clone --depth 1 -b "${POKY_BRANCH}" https://git.yoctoproject.org/git/poky
        cd poky
        git clone --depth 1 -b ${OE_BRANCH} https://github.com/openembedded/meta-openembedded.git
        git clone --depth 1 -b ${OE_BRANCH} https://github.com/kraj/meta-clang.git

    - uses: actions/checkout@v2
      with:
        path: 'poky/meta-codechecker'
    
    # We can cache up to 5Go
    # So we cache only sstate-cache and not the download directory
    - name: Cache sstates
      uses: actions/cache@v2
      with:
        path: |
          poky/build/sstate-cache
        key: ${{ matrix.oe-version-name }}-${{ matrix.oe-version }}
    
    # Github Actions can't build "bitbake simple-helloworld" from scratch,
    # because job can only run for a maximum of 360 minutes. So if the sstate_cache
    # is missing, we prefetch one. See https://github.com/samdolt/meta-codechecker/wiki
    - name: Prefetch sstate if missing
      run: |
        CACHE_VERSION="${{ matrix.oe-version-name }}-${{ matrix.oe-version }}"

        cd poky
        source $(pwd)/oe-init-build-env
        if [ ! -d "sstate-cache" ]; then
          echo "Download sstate-cache from S3"
          wget --no-verbose https://meta-codechecker-ci-cache.s3.amazonaws.com/sstate-cache_${CACHE_VERSION}.tar
          tar -xf sstate-cache_${CACHE_VERSION}.tar
        fi

    - name: Run bitbake
      run: |
        cd poky
        source $(pwd)/oe-init-build-env
        bitbake-layers add-layer ../meta-openembedded/meta-oe | tee ~/bitbake.log
        bitbake-layers add-layer ../meta-openembedded/meta-python | tee -a ~/bitbake.log
        bitbake-layers add-layer ../meta-clang | tee -a ~/bitbake.log
        bitbake-layers add-layer ../meta-codechecker | tee -a ~/bitbake.log
        bitbake simple-helloworld | tee -a ~/bitbake.log
    - name: Archive results
      uses: actions/upload-artifact@v2
      with:
        name: codechecker-report
        path: |
          poky/build/tmp/deploy/CodeChecker
          poky/build/*.log
        if-no-files-found: error
    
    - name: Check artifacts
      run: |
        cd poky/build/tmp/deploy/CodeChecker
        test -f "simple-helloworld/report-codeclimate/reports.json"
        test -f "simple-helloworld/report-html/index.html"
